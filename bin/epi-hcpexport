#!/usr/bin/env python
"""
Grabs the processed T1 from HCP folder. These are actually freesurfer outputs that
have already been converted to nifty and reoriented. So they match the outputs of
epi-fsexport. This to use as a standard anatomical this is
slow, but provides the highest-quality registration target. This also allows us
to take advantage of the high-quality freesurfer segmentations for nuisance time
series regression, if desired.

Usage:
    epi-hcpexport <path> <experiment>

Arguements:
     <path>         Path to epitome data directory.
     <experiment>   Name of the epitome experiment.

Options:
      --debug                  Debug logging in Erin's very verbose style
      -n,--dry-run             Dry run
      --help                   prints this message.

"""

import os, sys
import fnmatch
import subprocess
import shlex
import epitome as epi
from epitome.docopt import docopt

### Erin's little function for running things in the shell
def docmd(cmdlist):
    "sends a command (inputed as a list) to the shell"
    if DEBUG: print ' '.join(cmdlist)
    if not DRYRUN: subprocess.call(cmdlist)

def run_commands(path, directory, expt, subj, session):

    subjID = str(expt) + '_' + str(subj) + '_' + str(session)
    dir_i = os.path.join(os.environ['HCP_DIR'], subjID, 'T1')
    dir_o = os.path.join(directory, session)

    # convert freesurfer T1 to NII
    anat_T1 = os.path.join(dir_o, 'anat_T1.nii.gz')
    if os.path.isfile(anat_T1) == False:
        docmd(['cp',
            os.path.join(dir_i, 'T1w.nii.gz'),
            anat_T1])

    # convert the freesurfer brain mask (made from wmparc)
    anat_T1_brain_mask = os.path.join(dir_o, 'anat_T1_brain_mask.nii.gz')
    if os.path.isfile(anat_T1_brain_mask) == False:
        docmd(['cp',
            os.path.join(dir_i, 'brainmask_fs.nii.gz'),
            anat_T1_brain_mask])

    # multiply the freesurfer brainmask by the T1 to get the _brain.nii.gz
    anat_T1_brain = os.path.join(dir_o, 'anat_T1_brain.nii.gz')
    if os.path.isfile(dir_o + '/anat_T1_brain.nii.gz') == False:
        docmd(['fslmaths', anat_T1,
            '-mul', anat_T1_brain_mask,
            anat_T1_brain])
        
    # cp APARC atlas
    anat_aparc = os.path.join(dir_o + 'anat_aparc_brain.nii.gz')
    if os.path.isfile(anat_aparc) == False:
        docmd(['cp',
            os.path.join(dir_i, 'aparc+aseg.nii.gz'),
            anat_aparc])

    # cp MGZ APARC2009 atlas
    anat_aparc2009 = os.path.join(dir_o + 'anat_aparc2009_brain.nii.gz')
    if os.path.isfile(anat_aparc2009) == False:
        docmd(['cp',
            os.path.join(dir_i, 'aparc.a2009s+aseg.nii.gz'),
            anat_aparc2009])


def main():
    arguments = docopt(__doc__)
    path = arguments['<path>']
    expt = arguments['<experiment>']
    DEBUG = arguments['--debug']
    DRYRUN = arguments['--dry-run']

    # get subject numbers
    subjects = epi.utilities.get_subj(os.path.join(path, expt))

    # get directory of sessions
    for subj in subjects:
        directory = os.path.join(path, expt, subj, 'T1')

        if os.path.isdir(directory) == False:
          continue

        # get all sessions
        for session in os.listdir(directory):
            if os.path.isdir(os.path.join(directory, session)) == True:
                #export all FREESURFER data per session
                run_commands(path, directory, expt, subj, session)

if __name__ == "__main__":
    main()
