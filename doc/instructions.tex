%% EPItome-xl User Manual, Viviano, Joseph David Apr. 2014
\documentclass[final,titlepage,letterpaper,oneside,12pt]{article}
\usepackage[usenames,dvipsnames]{xcolor} % colors
\usepackage{tikz}                       % graphs
\usepackage{caption}                    % figure captions
\usepackage[utf8]{inputenc}             % utf8 encoding compatibility
\usepackage{fourier}                    % fonts
\usepackage[T1]{fontenc}                % fonts
\usepackage{natbib}                     % bibliography
\usepackage{dirtree}
\usepackage[colorlinks=true, pdfstartview=FitV, linkcolor=MidnightBlue, citecolor=MidnightBlue,urlcolor=MidnightBlue]{hyperref}                % custom colors
\usetikzlibrary{arrows}                 % arrows
\usepackage{amsmath}                    % equations
\usepackage{epigraph}                   % quotation
\renewcommand{\texttt}[2][BrickRed]{\textcolor{#1}{\ttfamily #2}}% \texttt[<color>]{<stuff>}
\newcommand{\atilde}{\raise.17ex\hbox{$\scriptstyle\mathtt{\sim}$}}
\renewcommand\epigraphflush{flushright} % 
\renewcommand\epigraphsize{\normalsize} % 
\setlength\epigraphwidth{0.7\textwidth} % 
\definecolor{titlepagecolor}{cmyk}{1,.60,0,.40} % custom color

\newenvironment{blockquote}{%
  \par%
  \medskip
  \leftskip=4em\rightskip=2em%
  \noindent\ignorespaces}{%
  \par\medskip}

%% Title Page
\makeatletter                       
\def\printauthor{%                  
    {\normalsize \@author}}              
\makeatother
\author{%
    Joseph D. Viviano \\
    Department of Biology \\
    York University \\
    Toronto, ON, CA \\
    joseph.d.viviano@gmail.com
}

\newcommand\titlepagedecoration{%
\begin{tikzpicture}[remember picture,overlay,shorten >= -10pt]

\coordinate (aux1) at ([yshift=-15pt]current page.north east);
\coordinate (aux2) at ([yshift=-410pt]current page.north east);
\coordinate (aux3) at ([xshift=-4.5cm]current page.north east);
\coordinate (aux4) at ([yshift=-150pt]current page.north east);

\end{tikzpicture}%
}

\begin{document}
\begin{titlepage}

\noindent
\begin{center}
\begin{Huge}
EPItome-xl\par
\end{Huge}
\end{center}
\vspace*{2cm}
\epigraph{As long as our brain is a mystery, the universe, the reflection of the structure of the brain will also be a mystery.}%
{\textsc{Santiago Ram√≥n y Cajal}}
\null\vfill
\vspace*{1cm}
\noindent
\hfill
\begin{minipage}{0.55\linewidth}
    \begin{flushright}
        \printauthor
    \end{flushright}
\end{minipage}
%
\begin{minipage}{0.02\linewidth}
    \rule{1pt}{72pt}
\end{minipage}
\titlepagedecoration
\end{titlepage}

% Table of contents
\tableofcontents
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Overview of the Pipeline
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

EPItome-xl is a program designed for the flexible construction of MRI pre-processing pipelines, with a focus on functional MRI images and their associated problems. Its primary function is to take BASH modules and chain them together in any way the user desires to create a set of batch-processing scripts for an MRI experiment. These modules are not necessarily dependent on one another, allowing users of this package to easily extend the functionality of EPItome-xl by simply depositing a shell script into the appropriate module folder and writing the associated python wrapper command (and documentation!)

The goal of this design is to allow multiple levels of control for users of different skills with the same interface. EPItome facilitates the construction of very robust pre-processing scripts that can be run on your computer or in a distributed computing environment by only answering a few high-level questions, hopefully making it easy for beginners to get started. The scripts that are output by these commands are otherwise fully tweak-able and well commented -- they encourage experimentation. These modified modules could eventually evolve into new features altogether, which are easily added to the existing pool.

This system is also designed to facilitate easy-to-reproduce research, as these scripts can be easily re-purposed for new experiments that follow the EPItome folder structure. In this way, the outputs of EPItome act as your lab notebook, and can be shared with collaborators or reviewers.

This manual will progress to more advanced topics in the end. First, I will explain the basic use of EPItome-xl. Next, I'll walk the user through a few common pre-processing tasks. I'll then explain the modules one-by-one, and finish with an explanation on how to add new modules.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Requirements
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Requirements \& Dependencies}

EPItome contains a small number of programs that actually manipulate data, but also makes heavy use of widely-used MRI analysis tools and a number of python distributions. The user is assumed to have properly installed and configured FSL, AFNI, Freesurfer, and the python packages numpy, scipy, and matplotlib.

The program itself was built and tested on a Ubuntu 12.04 server. I imagine it will work well in any Linux environment. It should run on Mac OS X as well, but this remains unverified. There will be no support for Windows.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The functionality of the pipeline
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Setting Up EPItome-xl}

After installation, EPItome requires you to specify a few paths. These settings can be found in the /epitome/config.py file.

\begin{itemize}
    \item{dir\_data: should point to your MRI experiment folder.}
    \item{dir\_pipe: should point to your installation of EPItome-xl.}
    \item{dir\_afni: should point to your installation of AFNI.}
    \item{cores: could be set to the maximum number of cores you wish EPItome to use (defaults to the maximum possible -1).}
\end{itemize}

EPItome-xl comes with a few command-line interfaces. EPItome is used to inspect data in the MRI directory, returns information on the currently-available modules, can be used to construct new pipelines, and to remove unwanted data from the MRI directory cleanly. EPIphysio is a tool built to parse physiological data from the BIOPAK 150 unit we have installed at York University (Toronto), and might need to be adapted / extended to work with other units. EPIfolder is used to generate an appropriate folder structure in the MRI directory for the EPItome pipeline to work on.

The MRI directory itself must be organized as follows:

\dirtree{%
    .1 /.
    .2 EXPERIMENTS.
    .3 SUBJECTS.
    .4 MODE.
    .5 SESS.
    .6 RUN.
    .2 FREESURFER.
    .3 SUBJECTS.
}

\noindent The Freesurfer subject directory should point to the Freesurfer directory in your MRI folder -- this can easily be accomplished using a link. The remaining folder structure is perhaps best generated by using the included EPIfolder tool (or via a home-brew script).

\subsection{Folders}

The folder structure is integral to EPItome -- if it is flawed, the pipeline will fail in mysterious ways. The structure itself is designed to be thought of as a tree. At the roots of the tree are the individual files collected at the scanner. As we ascend the tree, files are combined across sessions, image modalities, and subjects, so one finds experiment-wide outputs at the highest levels.

\subsubsection{EXPERIMENTS}

This is a set of folders containing entire experiments. There are no important naming conventions, but it seems advisable (for consistency) to make the folder names all capitals, and short (e.g., \texttt{LINGASD} for `language study on those with autism spectrum disorder').

\subsubsection{SUBJECTS}

Once again, these are simply folders with participant names. They follow no convention, but should be consistent for your own sake.

\subsubsection{MODE}

Image modality folders seperate images of different kinds: anatomicals, EPI's collected using differing sequences, or EPI's of different task-types (e.g., rest vs. two-back matching). The T1 directory \textbt{must} exist for each subject at the very minimum in SESS01.


\subsubsection{SESS}
\subsubsection{RUN}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The functionality of the pipeline
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Pipeline}

For the pipeline to work, your RAW data must be converted to the appropriate format in the WORKING directory. EPItome-xl should be installed and configured properly on your server (code \& up-to-date installation instructions are available from \href{https://github.com/josephdviviano/EPItome-xl}{GitHub}).

What follows is a description of what each module in EPItome-xl does. These modules can be easily chained together manually, or by using the command-line interface included with the pipeline. New modules are simply bash scripts which call various programs, including FSL, Freesurfer, AFNI, and custom python programs. Therefore, functionality of EPItome is easily extended without perturbing the function of older modules.

The types of modules included can be roughly split into 4 categories: freesurfer, pre-processing, quality-control, and cleanup.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Freesurfer}

Right now, the default freesurfer recon-all is run on every participant before further processing. This is to produce surface files that can be used for cortical smoothing / data visualization, and the automatic generation of tissue masks which can be used for the generation of nuisance regressors. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{fsrecon.py}
Usage: \texttt{fsrecon.py <data\_directory> <experiment> <modality> <cores>} \

\begin{blockquote}
data\_directory -- full path to your MRI/WORKING directory. \\
experiment -- name of the experiment being analyzed. \\
modality -- image modality to import (normally T1). \\
cores -- number of cores to dedicate (one core per run). \
\end{blockquote}

\noindent This sends each subject's T1s through the Freesurfer pipeline. It uses multiple T1s per imaging session, but does not combine them between sessions. Data is output to the dedicated FREESURFER directory, and should be exported to the MRI analysis folders using \texttt{fsexport.py}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{fsexport.py}
Usage: \texttt{fsexport.py <data\_directory> <experiment>}

\begin{blockquote}
data\_directory -- full path to your MRI/WORKING directory. \\
experiment -- name of the experiment being analyzed. \
\end{blockquote}

\noindent Imports processed T1s from Freesurfer to the experiment directory.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Pre-Processing}

This contains the lion's share of the pipeline. Every run of EPItome begins with \texttt{init\_EPI}, which contains a non-contentious set of pre-processing steps for EPI images. THe following stages can be chained together at will to preform de-noising, spatial transformations, projections to surface-space, and spatial smoothing.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{init\_EPI}
Usage: \texttt{init\_EPI <data\_quality> <del\_tr> <t\_pattern> <normalization> <masking>}

\begin{blockquote}
data\_quality -- `low' for poor internal contrast, otherwise `high'. \\
del\_tr -- number of TRs to remove from the beginning of the run. \\
t\_pattern -- slice-timing at acquisition (from AFNI's 3dTshift). \
normalization -- voxel wise time series normalization. One of `zscore', `pct', `demean'. \\
masking -- EPI brain masking tolerance. One of `loose', `normal' `tight'. \
\end{blockquote}

\noindent Works from the raw data in each RUN folder. It performs general pre-processing for all fMRI data:

\begin{itemize} \itemsep-2pt
    \item{Orients data to RAI}
    \item{Deletes initial time points (optionally)}
    \item{Removes data outliers}
    \item{Slice time correction}
    \item{Deobliques \& motion corrects data}
    \item{Creates session mean deskulled EPIs and whole-brain masks}
    \item{Scales and optionally normalizes each time series}
    \item{Calculates various statistics + time series}
\end{itemize}

Times series normalization can be accomplished in one of two ways: percent signal change, and scaling. For percent signal change, the data is normalized by the mean of each time series to mean = 100. A deviation of 1 from this mean value indicates 1\% signal change in the data. This is helpful for analyzing only relative fluctuations in the signal and is best at removing inter-session/subject/run variability, although it can also introduce rare artifacts in small localized regions of the images and may not play well with multivariate techniques such as partial least squares without accounting for these artifacts. Alternatively, one can scale the data, which applies single scaling factor to all voxels such that the global mean of the entire run = 1000. This will help normalize baseline shifts across sessions, runs, and participants. Your selection here might be motivated by personal preference, or in rarer cases, analytic requirements. When in doubt, it is safe to select `off', as scaling can be done later by hand, or `scale' if one is doing a simple GLM-style analysis. `pct' should be used by those with a good reason.

Masking options are provided to improve masking performance across various acquisition types, but it is very hard to devise a simple one-size fits all solution for this option. Therefore the QC outputs will be very important for ensuring good masking, and these options may need to be tweaked on a site-by-site basis. Luckily, many analysis methods do not rely heavily on mask accuracy. In cases that do, such as partial least squares / ICA / PCA analysis, close attention should be paid to the output of this step. Hopefully the `loose', `normal', and `tight' nomenclature are self-explanatory. Generally, it is best to start with normal, and adjust if required.

Prerequisites: None.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{combine\_volumes}
Usage: \texttt{combine\_volumes <func1\_prefix> <func2\_prefix>}

\begin{blockquote}
func1\_prefix -- functional data prefix (eg., smooth in func\_smooth).
func2\_prefix -- functional data prefix (eg., smooth in func\_smooth).
\end{blockquote}

\noindent Combines two functional files via addition. Intended to combine the outputs of \texttt{surfsmooth} \& \texttt{surf2vol} with \texttt{volsmooth}, but could be used to combine other things as well. The functional files should not have non-zeroed regions that overlap, or the output won't make much sense.

Prerequisites: Two EPI modules with unique output prefixes. Intended to be used to combine the outputs of \texttt{volsmooth} and \texttt{surfsmooth} in a single volume. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_calc\_AFNI}
Usage: \texttt{linreg\_calc\_AFNI <cost> <reg\_dof> <data\_quality>}

\begin{blockquote}
cost -- cost function minimized during registration. \\
reg\_dof -- `big\_move' or `giant\_move' (from align\_EPI\_anat.py). \\
data\_quality -- `low' for poor internal contrast, otherwise `high'. \
\end{blockquote}

\noindent Uses AFNI's align\_EPI\_anat.py to calculate linear registration between EPI <--> T1 <--> MNI152, and generate an EPI template registered to T1 \& T1 registered to EPI (sessionwise). Specific options can be found in the command-line interface's help function.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_calc\_FSL}
Usage: \texttt{linreg\_calc\_FSL <cost> <reg\_dof> <data\_quality>}

\begin{blockquote}
cost -- cost function minimized during registration (see FSL FLIRT). \\
reg\_dof -- 6, 7, 9, or 12 degrees of freedom (see FSL FLIRT), \\
data\_quality -- `low' for poor internal contrast, otherwise `high'. \
\end{blockquote}

\noindent Uses FSL's FLIRT to calculate linear registration between EPI <--> T1 <--> MNI152, and generate an EPI template registered to T1 \& T1 registered to EPI (sessionwise). Specific options can be found in the command-line interface's help function.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_EPI2MNI\_AFNI}
Usage: \texttt{linreg\_EPI2MNI\_AFNI <func\_prefix> <voxel\_dims>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
voxel\_dims -- target voxel dimensions (isotropic). \
\end{blockquote}

\noindent Prepares data for analysis in MNI standard space.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_AFNI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_EPI2MNI\_FSL}
Usage: \texttt{linreg\_EPI2MNI\_FSL <func\_prefix> <voxel\_dims>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg., smooth in func\_smooth). \\
voxel\_dims -- target voxel dimensions (isotropic). \
\end{blockquote}

\noindent Prepares data for analysis in MNI standard space.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_FSL}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_FS2EPI\_AFNI}
Usage: \texttt{linreg\_FS2EPI\_AFNI}

\noindent Brings Freesurfer atlases in register with single-subject EPIs.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_AFNI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_FS2EPI\_FSL}
Usage: \texttt{linreg\_FS2EPI\_FSL}

\noindent Brings Freesurfer atlases in register with single-subject EPIs.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_FSL}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{linreg\_FS2MNI\_FSL}
Usage: \texttt{linreg\_FS2MNI\_FSL}

\noindent Brings Freesurfer atlases in register with MNI standard space.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_FSL}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{gen\_regressors}
Usage: \texttt{gen\_regressors <func\_prefix>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth).
\end{blockquote}

\noindent Creates a series of regressors from fMRI data and a freesurfer segmentation: 

\begin{itemize} \itemsep-2pt
	\item{white matter + eroded mask}
	\item{ventricles + eroded mask}
	\item{grey matter mask}
	\item{brain stem mask}
	\item{dialated whole-brain mask}
	\item{draining vessels mask}
	\item{local white matter regressors + 1 temporal lag}
	\item{ventricle regressors + 1 temporal lag}
	\item{draining vessel regressors + 1 temporal lag}
\end{itemize}

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_AFNI/FSL}, \texttt{linreg\_FS2EPI\_AFNI/FSL}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{gen\_gcor}
Usage: \texttt{gen\_gcor <func\_prefix>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth).
\end{blockquote}

\noindent Calls an AFNI script to calculate the global correlation for each concatenated set of runs (across all sessions). Useful for resting state functional connectivity experiments.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{filter}
Usage: \texttt{filter <func\_prefix> <det> <gs> <vent> <dv> <wm\_loc> <wm\_glo>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
det -- polynomial order to detrend each voxel against. \\
gs -- if == on, regress mean global signal from each voxel. \\
vent -- if == on, regress mean ventricle signal from each voxel. \\
dv -- if == on, regress mean draining vessel signal from each voxel. \\
wm\_loc -- if == on, regress local white matter from target voxels. \\
wm\_glo -- if == on, regress global white matter for all voxels. \

\end{blockquote}

\noindent This computes detrended nuisance time series, fits each run with a computed noise model, and subtracts the fit. Computes temporal SNR. This program always regresses the motion parameters \& their first lags, as well as physiological noise regressors generated my McRetroTS if they are available. The rest are optional, and generally advisable save global mean regression.

Prerequisites: \texttt{init\_EPI}, \texttt{linreg\_calc\_AFNI/FSL}, \texttt{linreg\_FS2EPI\_AFNI/FSL}, \texttt{gen\_regressors}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{TRdrop}
Usage: \texttt{TRdrop <func\_prefix> <head\_size> <FD\_thresh> <DV\_thresh>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
head\_size -- head radius in mm (def. 50 mm). \\
thresh\_FD -- censor TRs with $\Delta$ motion > $x$ mm (def. 0.3 mm). \\
thresh\_DV -- censor TRs with $\Delta$ GS change > $x$ \% (def. \href{http://upload.wikimedia.org/wikipedia/en/1/16/Drevil_million_dollars.jpg}{1000000} \%). \
\end{blockquote}

\noindent This removes motion-corrupted TRs from fMRI scans and outputs shortened versions for connectivity analysis (mostly). By default, DVARS regression is set of OFF by using a very, very high threshold.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{lowpass}
Usage: \texttt{lowpass <func\_prefix> <mask\_prefix> <filter> <cutoff>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
mask\_prefix -- mask data prefix (eg., EPI\_mask in anat\_EPI\_mask). \\
filter -- filter type: `median', `average', `kaiser', or `butterworth'. \\
cutoff -- filter cuttoff: either window length, or cutoff frequency. \
\end{blockquote}

\noindent This low-passes input data using the specified filter type and cutoff. 

Both `median' and `average' filters operate in the time domain and therefore, the best cutoff values are odd (and must be larger than 1 to do anything). Time-domain filters are very good at removing high-frequency noise from the data without introducing any phase-shifts or ringing into the time series. When in doubt, a moving average filter with window length of 3 is a decent and conservative choice.

Alternatively, the `kaiser' and `butterworth' filters work in the frequency domain and accept a cutoff in Hz (people tend to use a default of 0.1). Both are implemented as bi-directional FIR filters. The kaiser window is high order and permits reasonably sharp rolloff with minimal passband ringing for shorter fMRI time series. The butterworth filter is of low order and achieves minimal passband ringing at the expense of passband roll off (in layman's terms, butterworth filters will retain more high-frequency content than a kaiser filter with equivalent cutoff). The effect of the passband ringing is an empirical question that would be best tested by the User.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{surfsmooth}
Usage: \texttt{surfsmooth <func\_prefix> <FWHM>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
FWHM -- full-width half-maximum of the gaussian kernel convolved with the surface data. \
\end{blockquote}

\noindent This spatially-smooths cortical data along the surface mesh, estimated by Freesurfer.

Prerequisites: \texttt{init\_EPI}, \texttt{vol2surf}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{surf2vol}
Usage: \texttt{surf2vol <func\_prefix> <target\_prefix>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth). \\
target\_prefix -- target data prefix (eg.,smooth in func\_smooth). \
\end{blockquote}

\noindent This projects surface data back into a functional volume with the same properties as <target\_prefix>.

Prerequisites: \texttt{init\_EPI}, \texttt{vol2surf}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{vol2surf}
Usage: \texttt{vol2surf <func\_prefix>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth).
\end{blockquote}

\noindent Projects functional data from volume space to a Freesurfer generated cortical mesh.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{volsmooth}
Usage: \texttt{volsmooth <func\_prefix> <mask\_prefix> <FWHM>}

\begin{blockquote}
func\_prefix -- functional data prefix (eg., smooth in func\_smooth).
mask\_prefix -- mask data prefix (eg., EPI\_mask in anat\_EPI\_mask).
func\_prefix -- functional data prefix (eg.,smooth in func\_smooth).
\end{blockquote}

\noindent Re-samples a mask containing one or more labels to the functional data and smooths within unique values. All zero values in the mask are zeroed out in the output. The output of this can be combined with the outputs of \texttt{surfsmooth} \& \texttt{surf2vol} using \texttt{combine\_volumes}.

Prerequisites: \texttt{init\_EPI}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Quality Control}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% References, both on server building and MRI analysis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Further Reading}

%% End of document. Go to reference list.
\newpage 
\bibliographystyle{apalike}
\bibliography{harford}
\end{document}
